<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.8/css/all.css">
    <link rel="stylesheet" type="text/css" href="../css/common.css">

    <title>Dashboard</title>
    <link rel="icon" href="../images/icon.png" type="image/icon type">
</head>

<body class="body-inside">
    <div id="ias">
        <ul class="nav nav-tabs nav-justified">
            <li class="nav-item" role="presentation">
                <a class="nav-link active" href="../dashboard/dashboard.html">Dashboard</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="../application/application.html">Application Upload</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="../sensor/sensor.html">Sensor Registration</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="../query/query.html">Sensor Query</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="../login/login.html">Logout</a>
            </li>
        </ul>
    </div>

    <div class="center">
        <h1>Service Dashboard</h1>
    </div>
   <?php
   
      $servername = "localhost";
      $username = "admindb";
      $password = "password";
      $dbname = "mydetails";
      // Create connection
      $conn = new mysqli($servername, $username, $password,$dbname);
      // Check connection
      if ($conn->connect_error) {
         die("Connection failed: " . $conn->connect_error);
      } 
      //echo "Connected successfully";
      $sql = "select username,token from details";
      $result = $conn->query($sql);
      if($result->num_rows == 0){
         # this check is to ensure user is logged in
         $newURL = "http://0.0.0.0/index.html";
         header('Location: '.$newURL);
         exit();
      }
      $row = $result->fetch_assoc();
      $token = $row["token"];
      $username = $row["username"];

      if(isset($_POST['ststop']))
      {
         echo $_POST['ststop'];
         $arr = explode(":",$_POST['ststop']);
         $applicationname = $arr[0];
         $servicename = $arr[1];
         $command = $arr[2];
         echo "command for ".$applicationname."->".$servicename." for ".$username." to ".$command;
         $payload->appname = $applicationname;
         $payload->serviceid = $servicename;
         $payload->username = $username;
         $payload->request = $command;
         $jsonpayload = json_encode($payload);
         $url = "http://0.0.0.0:5056/sendToScheduler";
         $ch = curl_init();
         curl_setopt($ch,CURLOPT_URL, $url);
         curl_setopt($ch,CURLOPT_POST, true);
         curl_setopt($ch,CURLOPT_POSTFIELDS, $jsonpayload);
         curl_setopt($ch,CURLOPT_RETURNTRANSFER, true); 
         $result = curl_exec($ch);
         //echo $jsonobj;
      }

      $myObj->token = $token;
      $myJSON = json_encode($myObj);
      $url = "http://0.0.0.0:5056/req";
      $ch = curl_init();
      curl_setopt($ch,CURLOPT_URL, $url);
      curl_setopt($ch,CURLOPT_POST, true);
      curl_setopt($ch,CURLOPT_POSTFIELDS, $myJSON);
      curl_setopt($ch,CURLOPT_RETURNTRANSFER, true); 
      $result = curl_exec($ch);
      //echo $jsonobj;
      $temp = json_decode($result,true);
      if($temp == "[]"){
         //user exists but no services uploaded yet
         echo "<center><h2>No Services yet<h2></center>";
      }else{
      $data = json_decode($temp,true);
      echo "<div id=\"data\" class=\"container\">
      <table class=\"table table-bordered table-hover\">";
      $tc = "<thead class=\"thead-dark\">
      <tr>
          <th class=\"text-center\">Application Name</th>
          <th class=\"text-center\">Service Name</th>
          <th class=\"text-center\">Status</th>
          <th class=\"text-center\">Start/Stop</th>
          <th class=\"text-center\">View Output</th>
      </tr>
      </thead>
      <tbody>";
      for($outer=0;$outer<sizeof($data);$outer++){
         for($inner=0;$inner<sizeof($data[$outer][data]);$inner++){
            $concat1 = $data[$outer][appname].":".$data[$outer][data][$inner][serviceid];
            $concat2 = $data[$outer][appname].":".$data[$outer][data][$inner][servicename];
            $tempstatus = $data[$outer][data][$inner][status];
            $tc.="<tr>
               <td class=\"text-center\">".$data[$outer][appname]."</td>
               <td class=\"text-center\">".$data[$outer][data][$inner][servicename]."</td>";
            if($tempstatus == "Running")
            {
               $concat1.=":"."Stop".":".$username;
               $buttonValue = "Stop";
               $scheduledstatus = $data[$outer][data][$inner][scheduled];
               if ($scheduledstatus == "False")
               {
                  $tc.="<td class=\"text-center\">".$data[$outer][data][$inner][status]."</td>
                  <form method=\"post\" action=\"".$_SERVER["PHP_SELF"]."\">
                  <td class=\"text-center\">
                  <button type=\"submit\" class=\"btn btn-success\" style=\"width:50%;\" name=\"ststop\" value=\"".$concat1."\">".$buttonValue."</button>
                  </td>
                  </form>
                  <form action=\"showOutput.php\" target=\"_blank\" method=\"POST\">
                  <td class=\"text-center\">
                  <button type=\"submit\" class=\"btn btn-info\" style=\"width:50%;\" name=\"opinfo\" value=\"".$concat2."\">View output</button>
                  </td>
                  </form>
                  </tr>";
               }else{
                  $concat1.=":"."Start".":".$username;
                  $tc.="<td class=\"text-center\">".$data[$outer][data][$inner][status]."</td>
                  <td class=\"text-center\"></td>
                  <form action=\"showOutput.php\" target=\"_blank\" method=\"POST\">
                  <td class=\"text-center\">
                  <button type=\"submit\" class=\"btn btn-info\" style=\"width:50%;\" name=\"opinfo\" value=\"".$concat2."\">View output</button>
                  </td>
                  </form>
                  </tr>";
               }
            }else{
               $scheduledstatus = $data[$outer][data][$inner][scheduled];
               if( $scheduledstatus == "True")
               {
                  $concat1.=":"."Start".":".$username;
                  $tc.="<td class=\"text-center\">".$data[$outer][data][$inner][status]."</td>
                  <td class=\"text-center\"></td>
                  <form action=\"showOutput.php\" target=\"_blank\" method=\"POST\">
                  <td class=\"text-center\">
                  <button type=\"submit\" class=\"btn btn-info\" style=\"width:50%;\" name=\"opinfo\" value=\"".$concat2."\">View output</button>
                  </td>
                  </form>
                  </tr>";
               }else{
                  $concat1.=":"."Start".":".$username;
                  $buttonValue = "Start";
                  $tc.="<td class=\"text-center\">".$data[$outer][data][$inner][status]."</td>
                  <form method=\"post\" action=\"".$_SERVER["PHP_SELF"]."\">
                  <td class=\"text-center\">
                  <button type=\"submit\" class=\"btn btn-success\" style=\"width:50%;\" name=\"ststop\" value=\"".$concat1."\">".$buttonValue."</button>
                  </td>
                  </form>
                  <form action=\"showOutput.php\" target=\"_blank\" method=\"POST\">
                  <td class=\"text-center\">
                  <button type=\"submit\" class=\"btn btn-info\" style=\"width:50%;\" name=\"opinfo\" value=\"".$concat2."\">View output</button>
                  </td>
                  </form>
                  </tr>";
               }
            }
         }
      }
 
   }
      $conn->close();
      echo $tc;
      echo "</tbody>
      </table>
  </div>";
   ?>
</body>

</html>