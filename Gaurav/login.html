<!DOCTYPE html>

<?php
   if( $_GET["user"] || $_GET["pwd"] ) {
      $usernameform = $_GET["user"];
      $passwordform = $_GET["pwd"];
      
      $dbservername = "localhost";
      $dbusername = "admindb";
      $dbpassword = "password";
      // Create connection
      $conn = new mysqli($dbservername, $dbusername, $dbpassword);
      // Check connection
      if ($conn->connect_error) {
         die("Connection failed: " . $conn->connect_error);
      } 
   
      $dbname = "mydetails";
      $dbassurance="create database if not exists ".$dbname;
      $result = $conn->query($dbassurance);
      $tablename = "details";
      $conn->close();


      $conn1 = new mysqli($dbservername, $dbusername, $dbpassword, $dbname);
      if ($conn1->connect_error) {
         die("Connection failed: " . $conn1->connect_error);
      } 
      $tableassurance="create table if not exists ".$tablename."(username varchar(30),token varchar(1000))";
      $conn1->query($tableassurance)or die("A MySQL error has occurred.<br />Error: (" . mysql_errno() . ") " . mysql_error());
      //echo $tableassurance;
      //$conn1->close();
      
      $myObj->username = $usernameform;
      $myObj->password = $passwordform;
      $myJSON = json_encode($myObj);
      //echo $myJSON;
      
      $url = "http://0.0.0.0:5056/login";
      $ch = curl_init();
      curl_setopt($ch,CURLOPT_URL, $url);
      curl_setopt($ch,CURLOPT_POST, true);
      curl_setopt($ch,CURLOPT_POSTFIELDS, $myJSON);
      curl_setopt($ch,CURLOPT_RETURNTRANSFER, true); 
      $result = curl_exec($ch);
      $response = json_decode($result,true);
      
      if($response[status] == "success"){
         $token = $response[token];
         echo $token;
         //need to do a check if we already have a tuple
         $checkquery = "select * from ".$tablename;
         $result = $conn1->query($checkquery);
         if ($result->num_rows > 0){
            //need to remove that entry
            $removeEntry = "delete from ".$tablename." where 1";
            $result = $conn1->query($removeEntry);
         }
         $insquery = "insert into ".$tablename." values(\"".$usernameform."\",\"".$token."\")";
         echo $insquery;
         $result = $conn1->query($insquery);
         echo $result->num_rows;
         $newURL = "http://0.0.0.0/dashboard.phtml";
         $conn1->close();
         header('Location: '.$newURL);
         exit();
      }else{
         $conn1->close();
         echo "Login failed, ";
         echo $response["message"];
      }
      
   }
?>


<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.8/css/all.css">
    <link rel="stylesheet" type="text/css" href="../css/common.css">

    <title>Login</title>
    <link rel="icon" href="../images/icon.png" type="image/icon type">
</head>

<body class="body-outside">
    <div class="card login-form">
        <div class="card">
            <article class="card-body">
                <h4 class="card-title text-center mb-4 mt-1">Login</h4>
                <hr>
                <p class="text-center message">Text if required</p>
                <form action = "<?php $_PHP_SELF ?>" method = "GET">
                    <div class="form-group">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"> <i class="fa fa-user"></i> </span>
                            </div>
                            <input name="" class="form-control" placeholder="Username" type="text">
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"> <i class="fa fa-lock"></i> </span>
                            </div>
                            <input class="form-control" placeholder="******" type="password">
                        </div>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary btn-block"> Login </button>
                    </div>
                </form>
                <p class="divider-text">
                    <span class="bg-light">OR</span>
                </p>
                <p>
                    <a href="" class="btn btn-block btn-info"> <i></i>Sign Up</a>
                </p>
            </article>
        </div>
    </div>
</body>

</html>